<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>TinywebServer代码详解-http连接处理-下（6） | Maxswordsman</title><meta name="author" content="Maxswordsman"><meta name="copyright" content="Maxswordsman"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TinywebServer代码详解–http连接处理-下（6）该blog内容转自：最新版Web服务器项目详解 - 06 http连接处理（下） 该blog对上述内容进行补充（在本人的角度） 结合此前记录的blog一起学习：牛客WebServer项目实战（点击跳转） 原项目地址（点击跳转） 博主添加注释后项目地址（点击跳转）   一、基础知识1.stat函数用于检索文件的元数据，如文件大小、权">
<meta property="og:type" content="article">
<meta property="og:title" content="TinywebServer代码详解-http连接处理-下（6）">
<meta property="og:url" content="https://maxswordsman.github.io/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%8B%EF%BC%886%EF%BC%89/index.html">
<meta property="og:site_name" content="Maxswordsman">
<meta property="og:description" content="TinywebServer代码详解–http连接处理-下（6）该blog内容转自：最新版Web服务器项目详解 - 06 http连接处理（下） 该blog对上述内容进行补充（在本人的角度） 结合此前记录的blog一起学习：牛客WebServer项目实战（点击跳转） 原项目地址（点击跳转） 博主添加注释后项目地址（点击跳转）   一、基础知识1.stat函数用于检索文件的元数据，如文件大小、权">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://maxswordsman.github.io/image/head2.webp">
<meta property="article:published_time" content="2024-01-24T08:14:00.000Z">
<meta property="article:modified_time" content="2024-01-24T08:14:00.000Z">
<meta property="article:author" content="Maxswordsman">
<meta property="article:tag" content="项目开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://maxswordsman.github.io/image/head2.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://maxswordsman.github.io/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%8B%EF%BC%886%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TinywebServer代码详解-http连接处理-下（6）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-24 16:14:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = 'hidden';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}

preloader.initLoading()
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/image/head2.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movie/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/book/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Maxswordsman"><span class="site-name">Maxswordsman</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movie/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/book/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TinywebServer代码详解-http连接处理-下（6）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-24T08:14:00.000Z" title="发表于 2024-01-24 16:14:00">2024-01-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-24T08:14:00.000Z" title="更新于 2024-01-24 16:14:00">2024-01-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC/">WebServerC++</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TinywebServer代码详解-http连接处理-下（6）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer" />


<h2 id="TinywebServer代码详解–http连接处理-下（6）"><a href="#TinywebServer代码详解–http连接处理-下（6）" class="headerlink" title="TinywebServer代码详解–http连接处理-下（6）"></a>TinywebServer代码详解–http连接处理-下（6）</h2><p>该blog内容转自：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/451xNaSFHxcxfKlPBV3OCg">最新版Web服务器项目详解 - 06 http连接处理（下）</a></p>
<p>该blog对上述内容进行补充（在本人的角度）</p>
<p>结合此前记录的blog一起学习：<a href="https://maxswordsman.github.io/2024/01/21/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/%E7%89%9B%E5%AE%A2WebServer%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">牛客WebServer项目实战（点击跳转）</a></p>
<p>原项目地址<a target="_blank" rel="noopener" href="https://github.com/qinguoyi/TinyWebServer">（点击跳转）</a></p>
<p>博主添加注释后项目地址<a target="_blank" rel="noopener" href="https://github.com/maxswordsman/TinyWebServerBymyself">（点击跳转）</a></p>
<hr>
<hr>
<h3 id="一、基础知识"><a href="#一、基础知识" class="headerlink" title="一、基础知识"></a>一、基础知识</h3><h4 id="1-stat函数"><a href="#1-stat函数" class="headerlink" title="1.stat函数"></a>1.stat函数</h4><p>用于检索文件的元数据，如文件大小、权限和修改时间等。并将文件属性存储在结构体stat里</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="keyword">struct</span> stat *buf)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// struct stat 结构体定义</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stat</span> &#123;</span><br><span class="line">    <span class="type">mode_t</span>    st_mode;        <span class="comment">// 文件类型和权限</span></span><br><span class="line">    <span class="type">off_t</span>     st_size;        <span class="comment">// 文件大小（以字节为单位）</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">dev_t</span>     st_dev;         <span class="comment">// 设备ID</span></span><br><span class="line">    <span class="type">ino_t</span>     st_ino;         <span class="comment">// inode节点号</span></span><br><span class="line">    <span class="type">nlink_t</span>   st_nlink;       <span class="comment">// 硬链接数</span></span><br><span class="line">    <span class="type">uid_t</span>     st_uid;         <span class="comment">// 所有者用户ID</span></span><br><span class="line">    <span class="type">gid_t</span>     st_gid;         <span class="comment">// 所有者组ID</span></span><br><span class="line">    <span class="type">dev_t</span>     st_rdev;        <span class="comment">// 设备ID（如果是特殊文件）</span></span><br><span class="line">    <span class="type">blksize_t</span> st_blksize;     <span class="comment">// 文件系统I/O块大小</span></span><br><span class="line">    <span class="type">blkcnt_t</span>  st_blocks;      <span class="comment">// 占用的512字节块数</span></span><br><span class="line">    <span class="type">time_t</span>    st_atime;       <span class="comment">// 最后访问时间</span></span><br><span class="line">    <span class="type">time_t</span>    st_mtime;       <span class="comment">// 最后修改时间</span></span><br><span class="line">    <span class="type">time_t</span>    st_ctime;       <span class="comment">// 最后状态更改时间</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li><code>pathname</code>：指向要获取信息的文件路径的字符串指针</li>
<li><code>buf</code>：指向 <code>stat</code> 结构的指针，<code>stat</code> 结构将存储文件的状态信息</li>
</ul>
<p>return：</p>
<ul>
<li>返回值为<code>0</code>表示成功</li>
<li>返回值为<code>-1</code>表示失败，并设置 <code>errno</code> 来指示错误类型</li>
</ul>
<hr>
<hr>
<h4 id="2-内存映射"><a href="#2-内存映射" class="headerlink" title="2.内存映射"></a>2.内存映射</h4><p>如果想要实现进程间通信，可以通过函数创建一块内存映射区，和管道不同的是<strong>管道对应的内存空间在内核中</strong>，而<strong>内存映射区对应的内存空间在进程的用户区</strong>（用于加载动态库的那个区域），也就是说进程间通信使用的内存映射区不是一块，<strong>而是在每个进程内部都有一块</strong></p>
<p>由于每个进程的地址空间是独立的，各个进程之间也不能直接访问对方的内存映射区，需要通信的进程需要将各自的内存映射区和同一个磁盘文件进行映射，这样进程之间就可以通过磁盘文件这个唯一的桥梁完成数据的交互了</p>
<p><img src="https://gitee.com/zhou-xuezhi/mypic2/raw/master/img/20240614160151.png" alt="image-20240228204824768"></p>
<p>如上图所示：磁盘文件数据可以完全加载到进程的内存映射区也可以部分加载到进程的内存映射区，当进程A中的内存映射区数据被修改了，数据会被自动同步到磁盘文件，同时和磁盘文件建立映射关系的其他进程内存映射区中的数据也会和磁盘文件进行数据的实时同步，这个同步机制保障了各个进程之间的数据共享</p>
<hr>
<h5 id="（1）mmap函数"><a href="#（1）mmap函数" class="headerlink" title="（1）mmap函数"></a>（1）mmap函数</h5><p>使用内存映射可以实现进程间的通信，创建内存映射区的函数原型如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="comment">// 创建内存映射区</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li><code>addr</code>: 从动态库加载区的什么位置开始创建内存映射区，一般指定为<code>NULL</code>, 委托内核分配</li>
<li><code>length</code>: 创建的内存映射区的大小（单位：字节），实际上这个大小是按照<code>4k</code>的整数倍去分配的</li>
<li><code>prot</code>: 对内存映射区的操作权限<ul>
<li><code>PROT_READ</code>: 读内存映射区</li>
<li><code>PROT_WRITE</code>: 写内存映射区</li>
<li>如果要对映射区有读写权限:<code> PROT_READ | PROT_WRITE</code></li>
</ul>
</li>
<li><code>flags</code>:<ul>
<li><code>MAP_SHARED</code>: 多个进程可以共享数据，进行映射区数据同步</li>
<li><code>MAP_PRIVATE</code>: 映射区数据是私有的，不能同步给其他进程</li>
</ul>
</li>
<li><code>fd</code>: 文件描述符, 对应一个打开的磁盘文件，内存映射区通过这个文件描述符和磁盘文件建立关联</li>
<li><code>offset</code>: 磁盘文件的偏移量，文件从偏移到的位置开始进行数据映射，使用这个参数需要注意两个问题：<ul>
<li>偏移量必须是<code>4k</code>的整数倍, 写<code>0</code>代表不偏移</li>
<li>这个参数必须是大于 <code>0</code> 的</li>
</ul>
</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功: 返回一个内存映射区的起始地址</li>
<li>失败:<code> MAP_FAILED (that is, (void *) -1)</code></li>
</ul>
<p>注意事项：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 第一个参数 addr 指定为 <span class="literal">NULL</span> 即可</span><br><span class="line"><span class="number">2.</span> 第二个参数 length 必须要 &gt; <span class="number">0</span></span><br><span class="line"><span class="number">3.</span> 第三个参数 prot，进程间通信需要对内存映射区有读写权限，因此需要指定为：PROT_READ | PROT_WRITE</span><br><span class="line"><span class="number">4.</span> 第四个参数 flags，如果要进行进程间通信, 需要指定 MAP_SHARED</span><br><span class="line"><span class="number">5.</span> 第五个参数 fd，打开的文件必须大于<span class="number">0</span>，进程间通信需要文件操作权限和映射区操作权限相同</span><br><span class="line">     - 内存映射区创建成功之后, 关闭这个文件描述符不会影响进程间通信</span><br><span class="line"><span class="number">6.</span> 第六个参数 offset，不偏移指定为<span class="number">0</span>，如果偏移必须是<span class="number">4</span>k的整数倍</span><br></pre></td></tr></table></figure>

<p>内存映射区使用完之后也需要释放，释放函数原型如下：</p>
<hr>
<h5 id="（2）munmap函数"><a href="#（2）munmap函数" class="headerlink" title="（2）munmap函数"></a>（2）munmap函数</h5><p>内存映射区使用完之后也需要释放，释放函数原型如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li><code>addr</code>: <code>mmap()</code>的返回值, 创建的内存映射区的起始地址</li>
<li><code>length</code>: 和<code>mmap()</code>第二个参数相同即可</li>
</ul>
<p>返回值：</p>
<ul>
<li>函数调用成功返回 <code>0</code>，失败返回 <code>-1</code></li>
</ul>
<hr>
<h5 id="（3）进程通信实例"><a href="#（3）进程通信实例" class="headerlink" title="（3）进程通信实例"></a>（3）进程通信实例</h5><p><strong>无血缘关系的进程</strong></p>
<p>对于没有血缘关系的进程间通信，需要在每个进程中分别创建内存映射区，但是这些进程的内存映射区必须要关联相同的磁盘文件，这样才能实现进程间的数据同步</p>
<p><code>进程A code</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILENAME <span class="string">&quot;./text.txt&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 打开一个磁盘文件</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(FILENAME, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1111&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建内存映射区</span></span><br><span class="line">    <span class="type">char</span>* ptr = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, <span class="number">4000</span>, PROT_READ|PROT_WRITE,MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;mmap()&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* pt = <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将字符指针指向的内容写入 内存映射区</span></span><br><span class="line">    <span class="built_in">strcpy</span>(ptr,pt);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放内存映射区</span></span><br><span class="line">    <span class="built_in">munmap</span>(ptr, <span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>进程 B code</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FILENAME <span class="string">&quot;./text.txt&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 打开一个磁盘文件</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(FILENAME, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建内存映射区</span></span><br><span class="line">    <span class="type">void</span>* ptr = <span class="built_in">mmap</span>(<span class="literal">NULL</span>, <span class="number">4000</span>, PROT_READ|PROT_WRITE,</span><br><span class="line">                     MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;mmap()&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;从内存映射区读取数据: %s\n&quot;</span>,(<span class="type">char</span> *)ptr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放内存映射区</span></span><br><span class="line">    <span class="built_in">munmap</span>(ptr, <span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h4 id="3-iovec"><a href="#3-iovec" class="headerlink" title="3.iovec"></a>3.iovec</h4><p><code>iovec</code> 结构体在 C++ 中用于描述一个向量（数组）缓冲区。它通常与 <code>readv</code> 和 <code>writev</code> 函数一起使用，<strong>用于执行分散&#x2F;聚集<code> I/O</code> 操作。分散&#x2F;聚集<code>I/O</code>允许在一次系统调用中读取或写入多个缓冲区，从而提高<code>I/O</code>操作的效率</strong></p>
<p><strong>iovec</strong>结构体简介：</p>
<p><code>iovec</code> 结构体定义在头文件 <code>&lt;sys/uio.h&gt;</code> 中，其定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">iovec</span> &#123;</span><br><span class="line">    <span class="type">void</span>  *iov_base;    <span class="comment">// 指向缓冲区的起始地址</span></span><br><span class="line">    <span class="type">size_t</span> iov_len;     <span class="comment">// 缓冲区的长度</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="（1）readv函数"><a href="#（1）readv函数" class="headerlink" title="（1）readv函数"></a>（1）readv函数</h5><p><code>readv</code> 函数：从文件描述符读取数据到多个缓冲区</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">readv</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li><code>fd</code>：文件描述符</li>
<li><code>iov</code>：指向 <code>iovec</code> 结构体数组的指针</li>
<li><code>iovcnt</code>：<code>iovec</code> 结构体数组中的元素个数</li>
</ul>
<p>返回值：</p>
<ul>
<li>返回实际读取的字节数</li>
<li>返回 -1，并设置 <code>errno</code> 来指示错误类型</li>
</ul>
<hr>
<h5 id="（2）writev函数"><a href="#（2）writev函数" class="headerlink" title="（2）writev函数"></a>（2）writev函数</h5><p><code>writev</code> 函数：从多个缓冲区写入数据到文件描述符</p>
<p><code>writev</code>以顺序<code>iov[0]</code>，<code>iov[1]</code>至<code>iov[iovcnt-1]</code>从缓冲区中聚集输出数据。<code>writev</code>返回输出的字节总数，通常，它应等于所有缓冲区长度之和</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">writev</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li><code>fd</code>：文件描述符</li>
<li><code>iov</code>：指向 <code>iovec</code> 结构体数组的指针</li>
<li><code>iovcnt</code>：<code>iovec</code> 结构体数组中的元素个数</li>
</ul>
<p>返回值：</p>
<ul>
<li>返回实际写入的字节数</li>
<li>返回 -1，并设置 <code>errno</code> 来指示错误类型</li>
</ul>
<hr>
<h5 id="（3）实例"><a href="#（3）实例" class="headerlink" title="（3）实例"></a>（3）实例</h5><p><strong>读取数据</strong>：使用<code>readv</code>函数从文件描述符读取数据到多个缓冲区</p>
<p><code>example.txt</code>文件内容为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">012345678</span></span><br><span class="line"><span class="number">0123456789012345678</span></span><br><span class="line"><span class="number">01234567890123456789012345678</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;example.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备缓冲区</span></span><br><span class="line">    <span class="type">char</span> buf1[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> buf2[<span class="number">20</span>];</span><br><span class="line">    <span class="type">char</span> buf3[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置iovec结构体数组</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(buf1);  <span class="comment">// 留出一个位置给\0</span></span><br><span class="line">    iov[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span>(buf2);  <span class="comment">// 留出一个位置给\0</span></span><br><span class="line">    iov[<span class="number">2</span>].iov_base = buf3;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = <span class="keyword">sizeof</span>(buf3);  <span class="comment">// 留出一个位置给\0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用readv读取数据</span></span><br><span class="line">    <span class="type">ssize_t</span> nread = readv(fd, iov, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (nread == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;readv&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手动添加字符串结束符</span></span><br><span class="line">    buf1[iov[<span class="number">0</span>].iov_len<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    buf2[iov[<span class="number">1</span>].iov_len<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    buf3[iov[<span class="number">2</span>].iov_len<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Read &quot;</span> &lt;&lt; nread &lt;&lt; <span class="string">&quot; bytes.&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; buf1 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; buf2 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; buf3 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(base) zxz@ubuntu:~/Proj/C_C++/C++_Demo/3$ ./1</span><br><span class="line">Read 60 bytes.</span><br><span class="line">012345678</span><br><span class="line">0123456789012345678</span><br><span class="line">01234567890123456789012345678</span><br></pre></td></tr></table></figure>

<p><strong>写入数据</strong>：将多个缓冲区的数据写入文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;output.txt&quot;</span>, O_WRONLY | O_CREAT | O_TRUNC, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备数据</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf1 = <span class="string">&quot;Hello, &quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf2 = <span class="string">&quot;world!\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf3 = <span class="string">&quot;This is an example of writev.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置iovec结构体数组</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[3];</span></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = (<span class="type">void</span>*)buf1;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="built_in">strlen</span>(buf1);</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = (<span class="type">void</span>*)buf2;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="built_in">strlen</span>(buf2);</span><br><span class="line">    iov[<span class="number">2</span>].iov_base = (<span class="type">void</span>*)buf3;</span><br><span class="line">    iov[<span class="number">2</span>].iov_len = <span class="built_in">strlen</span>(buf3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用writev写入数据</span></span><br><span class="line">    <span class="type">ssize_t</span> nwritten = writev(fd, iov, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (nwritten == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;writev&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Wrote &quot;</span> &lt;&lt; nwritten &lt;&lt; <span class="string">&quot; bytes.&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭文件</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行，查看<code>output.txt</code>文件内容为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello, world!</span><br><span class="line">This is an example of writev.</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h4 id="4-va-start"><a href="#4-va-start" class="headerlink" title="4.va_start"></a>4.va_start</h4><p><code>va_start</code> 是一个宏，用于处理变长参数函数。它定义在 <code>&lt;cstdarg&gt;</code> 头文件中（在 C 中则是 <code>&lt;stdarg.h&gt;</code> 头文件）。<code>va_start</code> 用于初始化一个 <code>va_list</code> 对象，以便在变长参数函数中访问可变数量的参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个函数，计算多个数的总和</span></span><br><span class="line"><span class="comment">// 定义一个接收变长参数的函数。第一个参数 count 指定后续参数的数量</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span> count, ...)</span> &#123;</span><br><span class="line">    <span class="comment">// 声明一个 va_list （列表） 类型的变量，用于访问变长参数，va_list是用于存储参数的列表</span></span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="comment">// 初始化 va_list 变量，使其指向变长参数列表的第一个参数，初始化args来访问额外的参数</span></span><br><span class="line">    va_start(args, count);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        <span class="comment">// 使用 va_arg 宏访问变长参数列表中的每个参数。在此示例中，每个参数都是 int 类型</span></span><br><span class="line">        total += va_arg(args, <span class="type">int</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// va_end(args);：结束 va_list 的使用</span></span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Sum of 1, 2, 3, 4, 5: &quot;</span> &lt;&lt; sum(<span class="number">5</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Sum of 10, 20, 30: &quot;</span> &lt;&lt; sum(<span class="number">3</span>, <span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h4 id="5-vsnprintf"><a href="#5-vsnprintf" class="headerlink" title="5.vsnprintf()"></a>5.vsnprintf()</h4><p><code>vsnprintf</code> 是一个函数，用于将格式化的数据写入到字符缓冲区中，类似于 <code>snprintf</code>，但它使用一个 <code>va_list</code> 类型的参数列表。这在处理可变参数函数时非常有用。<code>vsnprintf</code> 函数定义在头文件 <code>&lt;cstdio&gt;</code> 或 <code>&lt;stdio.h&gt;</code> 中</p>
<p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vsnprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">char</span> *format, va_list ap)</span>;</span><br></pre></td></tr></table></figure>

<p><code>str</code>：目标缓冲区的指针，用于存储格式化后的字符串</p>
<p><code>size</code>：缓冲区的大小，以字符为单位。确保这个值足够大，以便存储最终的字符串和一个空终止字符</p>
<p><code>format</code>：格式字符串，类似于 <code>printf</code> 的格式字符串</p>
<p><code>ap</code>：一个 <code>va_list</code> 类型的参数列表，包含了变长参数</p>
<p>返回值：</p>
<ul>
<li>如果成功，则返回将要写入的字符数，不包括终止的空字符。如果返回值大于或等于 <code>size</code>，则表示输出被截断</li>
<li>如果出错，则返回一个负值</li>
</ul>
<p><strong>展示如何将格式化的数据写入缓冲区</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// write_formatted 函数接收一个缓冲区、缓冲区大小、格式字符串以及变长参数列表</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_formatted</span><span class="params">(<span class="type">char</span>* buffer, <span class="type">int</span> buffer_size, <span class="type">const</span> <span class="type">char</span>* format, ...)</span> &#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="comment">// 使用 va_start 初始化 va_list 变量 args</span></span><br><span class="line">    va_start(args, format);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 vsnprintf 将格式化的数据写入缓冲区</span></span><br><span class="line">    <span class="type">int</span> len = vsnprintf(buffer, buffer_size, format, args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查返回值以检测错误或输出被截断的情况</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;Formatting error occurred.&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= buffer_size) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;Output was truncated. Needed size: &quot;</span> &lt;&lt; len + <span class="number">1</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Formatted string: &quot;</span> &lt;&lt; buffer &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 va_end 结束对 va_list 的处理</span></span><br><span class="line">    va_end(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> write_buffer[WRITE_BUFFER_SIZE];</span><br><span class="line">    write_formatted(write_buffer, WRITE_BUFFER_SIZE, <span class="string">&quot;Hello, %s! You have %d new messages.&quot;</span>, <span class="string">&quot;Alice&quot;</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<hr>
<h3 id="二、流程图"><a href="#二、流程图" class="headerlink" title="二、流程图"></a>二、流程图</h3><h4 id="1-程序流程"><a href="#1-程序流程" class="headerlink" title="1.程序流程"></a>1.程序流程</h4><p>浏览器端发出<code>HTTP</code>请求报文，服务器端接收该报文并调用<code>process_read</code>对其进行解析，根据解析结果<code>HTTP_CODE</code>，进入相应的逻辑和模块</p>
<p>其中，服务器子线程完成报文的解析与响应；主线程监测读写事件，调用<code>read_once</code>和<code>http_conn::write</code>完成数据的读取与发送</p>
<p><img src="https://gitee.com/zhou-xuezhi/mypic2/raw/master/img/20240711090353.png" alt="image-20240711090353137"></p>
<hr>
<hr>
<h4 id="2-HTTP-CODE含义"><a href="#2-HTTP-CODE含义" class="headerlink" title="2.HTTP_CODE含义"></a>2.HTTP_CODE含义</h4><p>表示HTTP请求的处理结果，在头文件中初始化了八种情形，在报文解析与响应中只用到了七种</p>
<blockquote>
<p><code>NO_REQUEST</code></p>
<ul>
<li>请求不完整，需要继续读取请求报文数据</li>
<li>跳转主线程继续监测读事件</li>
</ul>
<p><code>GET_REQUEST</code></p>
<ul>
<li>获得了完整的<code>HTTP</code>请求</li>
<li>调用<code>do_request</code>完成请求资源映射</li>
</ul>
<p><code>NO_RESOURCE</code></p>
<ul>
<li>请求资源不存在</li>
<li>跳转<code>process_write</code>完成响应报文</li>
</ul>
<p><code>BAD_REQUEST</code></p>
<ul>
<li><code>HTTP</code>请求报文有语法错误或请求资源为目录</li>
<li>跳转<code>process_write</code>完成响应报文</li>
</ul>
<p><code>FORBIDDEN_REQUEST</code></p>
<ul>
<li>请求资源禁止访问，没有读取权限</li>
<li>跳转<code>process_write</code>完成响应报文</li>
</ul>
<p><code>FILE_REQUEST</code></p>
<ul>
<li>请求资源可以正常访问</li>
<li>跳转<code>process_write</code>完成响应报文</li>
</ul>
<p><code>INTERNAL_ERROR</code></p>
<ul>
<li>服务器内部错误，该结果在主状态机逻辑<code>switch</code>的<code>default</code>下，一般不会触发</li>
</ul>
</blockquote>
<hr>
<hr>
<h3 id="三、代码详解"><a href="#三、代码详解" class="headerlink" title="三、代码详解"></a>三、代码详解</h3><h4 id="1-do-request"><a href="#1-do-request" class="headerlink" title="1.do_request()"></a>1.do_request()</h4><p>这是一个功能逻辑单元， 当得到一个完整、正确的<code>HTTP</code>请求时，就需要分析目标文件的属性，如果目标文件存在、对所有用户可读，且不是目录，则使用<code>mmap</code>将其映射到内存地址<code>m_file_address</code>处（<strong>可以把文件的某个部分直接映射到进程的地址空间中，这样可以通过指针直接访问文件内容，而无需调用读写文件的系统调用。这通常可以提高文件操作的性能，因为减少了内核与用户空间之间的数据拷贝</strong>），并告诉调用者获取文件成功</p>
<p><code>process_read</code>函数的返回值是对请求的文件分析后的结果，一部分是语法错误导致的<code>BAD_REQUEST</code>，一部分是<code>do_request</code>的返回结果（在主状态机位于请求头状态时，获得一个完整的GET请求，则会<code>retutn do_request</code>；或者在主状态机位于请求体状态时，获得一个完整的<code>POST</code>请求，则会<code>return do_request</code>）</p>
<p><code>do_request</code>函数将网站根目录和<code>url</code>文件拼接，然后通过<code>stat</code>判断该文件属性。另外，为了提高访问速度，通过<code>mmap</code>进行映射，将普通文件映射到内存逻辑地址</p>
<p>为了更好的理解请求资源的访问流程，这里对各种各页面跳转机制进行简要介绍。其中，浏览器网址栏中的字符，即<code>url</code>，可以将其抽象成<code>ip:port/xxx</code>，<code>xxx</code>通过<code>html</code>文件的<code>action</code>属性进行设置</p>
<p><strong><code>m_url</code>为请求报文中解析出的请求资源，以<code>/</code>开头，也就是<code>/xxx</code>，项目中解析后的<code>m_url</code>有8种情况</strong>：</p>
<blockquote>
<p><code>/</code></p>
<ul>
<li><code>GET</code>请求，跳转到<code>judge.html</code>，即欢迎访问页面（在<code>parse_request_line</code>处理请求行时，当请求报文的请求头的<code>url</code>只有<code>/</code>则将<code>m_url</code>与<code>judge.html</code>界面进行拼接）</li>
</ul>
<p><code>/0</code></p>
<ul>
<li><code>POST</code>请求，跳转到<code>register.html</code>，即注册页面</li>
</ul>
<p><code>/1</code></p>
<ul>
<li><code>POST</code>请求，跳转到<code>log.html</code>，即登录页面</li>
</ul>
<p><code>/2CGISQL.cgi</code></p>
<ul>
<li><code>POST</code>请求，进行登录校验</li>
<li>验证成功跳转到<code>welcome.html</code>，即资源请求成功页面</li>
<li>验证失败跳转到<code>logError.html</code>，即登录失败页面</li>
</ul>
<p><code>/3CGISQL.cgi</code></p>
<ul>
<li><code>POST</code>请求，进行注册校验</li>
<li>注册成功跳转到<code>log.html</code>，即登录页面</li>
<li>注册失败跳转到<code>registerError.html</code>，即注册失败页面</li>
</ul>
<p><code>/5</code></p>
<ul>
<li><code>POST</code>请求，跳转到<code>picture.html</code>，即图片请求页面</li>
</ul>
<p><code>/6</code></p>
<ul>
<li><code>POST</code>请求，跳转到<code>video.html</code>，即视频请求页面</li>
</ul>
<p><code>/7</code></p>
<ul>
<li><code>POST</code>请求，跳转到<code>fans.html</code>，即关注页面</li>
</ul>
</blockquote>
<p>具体的登录和注册校验功能会在第12节进行详解，到时候还会针对html进行介绍</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @func:功能逻辑单元</span></span><br><span class="line"><span class="comment"> *       当得到一个完整、正确的HTTP请求时，就需要分析目标文件的属性</span></span><br><span class="line"><span class="comment"> *       如果目标文件存在、对所有用户可读，且不是目录，则使用mmap将其</span></span><br><span class="line"><span class="comment"> *       映射到内存地址m_file_address处，并告诉调用者获取文件成功</span></span><br><span class="line"><span class="comment"> *       内存映射，将文件内容直接映射到进程地址空间</span></span><br><span class="line"><span class="comment"> *       这样服务端进程可以像访问普通内存一样访问数据文件</span></span><br><span class="line"><span class="comment"> * @note:doc_root网站根目录，文件夹内存放请求的资源和跳转的html文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http_conn::HTTP_CODE <span class="title function_">http_conn::do_request</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 网站目录（资源目录）</span></span><br><span class="line">    <span class="built_in">strcpy</span>(m_real_file, doc_root);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(doc_root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// strrchr 函数查询 m_url中最后一次出现 / 位置的指针</span></span><br><span class="line">    <span class="comment">// 找到m_url中/的位置</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *p = <span class="built_in">strrchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理cgi</span></span><br><span class="line">    <span class="comment">// 实现登录和注册校验</span></span><br><span class="line">    <span class="keyword">if</span> (cgi == <span class="number">1</span> &amp;&amp; (*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span> || *(p + <span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 根据标志判断是登录检测还是注册检测</span></span><br><span class="line">        <span class="type">char</span> flag = m_url[<span class="number">1</span>];  <span class="comment">// 等价于*(p+1)</span></span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(m_url_real, m_url + <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将用户名和密码提取出来</span></span><br><span class="line">        <span class="comment">//eg:user=123&amp;passwd=123</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>], password[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">5</span>; m_string[i] != <span class="string">&#x27;&amp;&#x27;</span>; ++i)</span><br><span class="line">            name[i - <span class="number">5</span>] = m_string[i];</span><br><span class="line">        name[i - <span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = i + <span class="number">10</span>; m_string[i] != <span class="string">&#x27;\0&#x27;</span>; ++i, ++j)</span><br><span class="line">            password[j] = m_string[i];</span><br><span class="line">        password[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是初次注册情况</span></span><br><span class="line">        <span class="keyword">if</span>(*(p+<span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//如果是注册，先检测数据库中是否有重名的</span></span><br><span class="line">            <span class="comment">//没有重名的，进行增加数据</span></span><br><span class="line">            <span class="comment">//构建一个用于插入数据到数据库的user表中的 SQL 语句</span></span><br><span class="line">            <span class="type">char</span> *sql_insert = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">            <span class="built_in">strcpy</span>(sql_insert, <span class="string">&quot;INSERT INTO user(username, passwd) VALUES(&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, name);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;, &#x27;&quot;</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, password);</span><br><span class="line">            <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// find函数会返回一个迭代器，在map中找name键</span></span><br><span class="line">            <span class="comment">// 若找到了，迭代器会指向该键对应的键值对</span></span><br><span class="line">            <span class="comment">// 如果没有找到，迭代器将等于 users.end()，即指向 map 结尾的迭代器</span></span><br><span class="line">            <span class="keyword">if</span> (users.find(name) == users.end())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 没有找到，则注册的为新用户</span></span><br><span class="line">                m_lock.lock();</span><br><span class="line">                <span class="comment">// mysql_query 向数据库执行指令 sql_insert，成功return 0</span></span><br><span class="line">                <span class="type">int</span> res = mysql_query(mysql, sql_insert);</span><br><span class="line">                users.insert(<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;(name, password));</span><br><span class="line">                m_lock.unlock();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!res)</span><br><span class="line">                    <span class="comment">// 成功</span></span><br><span class="line">                    <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 注册失败，用户存在</span></span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果是登录，直接判断</span></span><br><span class="line">        <span class="comment">//若浏览器端输入的用户名和密码在表中可以查找到，返回1，否则返回0</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (users.find(name) != users.end() &amp;&amp; users[name] == password)</span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/welcome.html&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// m_url指向登陆失败的页面</span></span><br><span class="line">                <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/logError.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果请求资源为/0，表示跳转注册界面</span></span><br><span class="line">    <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将网站目录和/register.html进行拼接，更新到m_real_file中</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/register.html&quot;</span>);</span><br><span class="line">        <span class="comment">// m_url_real字符串复制到m_real_file字符串的len索引位置，进行拼接</span></span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果请求资源为/1，表示跳转登录界面</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将网站目录和/log.html进行拼接，更新到m_real_file中</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果请求资源为/5，表示跳转pic</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将网站目录和/picture.html进行拼接，更新到m_real_file中</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/picture.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果请求资源为/6，表示跳转video</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将网站目录和/video.html进行拼接，更新到m_real_file中</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/video.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果请求资源为/7，表示跳转weixin</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将网站目录和/fans.html进行拼接，更新到m_real_file中</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/fans.html&quot;</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line">        <span class="built_in">free</span>(m_url_real);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 在parse_request_line处理请求行时，当url只有/则将m_url与judge.html界面进行拼接</span></span><br><span class="line">        <span class="comment">// 如果以上均不符合，即不是登录和注册，直接将url与网站目录拼接</span></span><br><span class="line">        <span class="comment">// 这里的情况是跳转到judge.html界面即欢迎界面，请求服务器上的一个图片</span></span><br><span class="line">        <span class="comment">// 是一个GET请求</span></span><br><span class="line">        <span class="built_in">strncpy</span>(m_real_file + len, m_url, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过stat获取请求资源文件信息，成功则将信息更新到m_file_stat结构体</span></span><br><span class="line">    <span class="comment">// 失败返回NO_RESOURCE状态，表示资源不存在</span></span><br><span class="line">    <span class="keyword">if</span> (stat(m_real_file, &amp;m_file_stat) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> NO_RESOURCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断文件的权限，是否可读，不可读则返回FORBIDDEN_REQUEST状态</span></span><br><span class="line">    <span class="keyword">if</span> (!(m_file_stat.st_mode &amp; S_IROTH))</span><br><span class="line">        <span class="keyword">return</span> FORBIDDEN_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断文件类型，如果是目录，则返回BAD_REQUEST，表示请求报文有误</span></span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(m_file_stat.st_mode))</span><br><span class="line">        <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以只读方式获取文件描述符，通过mmap将该文件映射到内存中</span></span><br><span class="line">    <span class="type">int</span> fd = open(m_real_file, O_RDONLY);</span><br><span class="line">    m_file_address = (<span class="type">char</span> *)mmap(<span class="number">0</span>, m_file_stat.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//避免文件描述符的浪费和占用</span></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//表示请求文件存在，且可以访问</span></span><br><span class="line">    <span class="keyword">return</span> FILE_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h4 id="2-process-write"><a href="#2-process-write" class="headerlink" title="2.process_write()"></a>2.process_write()</h4><p>该函数在<code>process</code>函数中被调用，根据<code>process</code>函数中先调用的<code>process_read</code>函数解析请求报文，返回的<code>HTTP</code>状态码作为参数传入<code>process_write</code>函数进行判断，生成对应的响应报文存入<code>m_write_buf</code>中</p>
<p><code>process_read</code>函数解析请求报文，会返回的状态码如下，<code>process_write</code>会根据传入的<code>HTTP</code>状态码进行处理</p>
<blockquote>
<p><code>INTERNAL_ERROR</code>&#x2F;<code>BAD_REQUEST</code>&#x2F;<code>FORBIDDEN_REQUEST</code></p>
<ul>
<li><code>服务器内部错误</code>&#x2F;<code>请求报文语法错误</code>&#x2F;<code>URL中访问的资源没有访问权限</code></li>
<li>这些请求出错的情况，响应报文只包含一种，即写入到<code>m_write_buf</code>中的相关报错信息</li>
<li>只申请一个<code>iovec</code>（向量缓冲区中的缓冲区数量为1），指向<code>m_write_buf</code></li>
<li>服务器就需要为响应报文填入相关的错误状态码，错误信息</li>
</ul>
<p><code>FILE_REQUEST</code></p>
<ul>
<li><code>URL中访问的资源文件存在且可以访问</code></li>
<li>服务器为响应报文添加相关的正常的状态码</li>
<li>当前URL中请求资源文件存在且可以正常访问的情况，响应报文包含两种，写入到<code>m_write_buf</code>中的相关正常的状态信息，以及请求报文中URL申请访问的资源文件内容</li>
<li>会通过向量缓冲区<code>iovec</code>的两个<code>iovec</code>指针分别指向<code>m_write_buf</code>以及<code>m_file_address</code></li>
<li>在<code>process_read</code>函数中之前若请求报文解析正常，获得一个完整的请求报文，会通过调用<code>do_request</code>函数中使用<code>mmap</code>函数将请求报文中URL访问的文件映射到服务器进程内存中使用<code>m_file_address</code>进行指向，内存映射之后，访问<code>m_file_address</code>指针指向内容就是访问URL请求的资源文件内容</li>
</ul>
</blockquote>
<ul>
<li><code>iovec</code>是一个结构体，里面有两个元素，指针成员<code>iov_base</code>指向一个缓冲区，这个缓冲区是存放的是<code>writev</code>将要发送的数据。</li>
<li>成员<code>iov_len</code>表示实际写入的长度</li>
</ul>
<p><code>process_write</code>中的<code>iovec</code>结构体数组设置好之后，服务器会通过<code>writev</code>函数将两个缓冲区的数据写入到用于通信的套接字写缓冲区，发送给客户端</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:生成响应报文</span></span><br><span class="line"><span class="comment"> *      （根据process函数中调用process_read解析请求报文，返回的HTTP_CODE状态码,</span></span><br><span class="line"><span class="comment"> *      传入process_write函数判断进行对应响应报文的生成）</span></span><br><span class="line"><span class="comment"> *      服务器子线程调用process_write向m_write_buf中写入响应报文</span></span><br><span class="line"><span class="comment"> * note:响应报文组成-状态行-消息报头-空行-响应正文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::process_write</span><span class="params">(HTTP_CODE ret)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 服务器内部错误</span></span><br><span class="line">        <span class="keyword">case</span> INTERNAL_ERROR:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 状态行--500 Internal Server Error:服务器在执行请求时出现错误</span></span><br><span class="line">            add_status_line(<span class="number">500</span>, error_500_title);</span><br><span class="line">            <span class="comment">// 消息报头</span></span><br><span class="line">            add_headers(<span class="built_in">strlen</span>(error_500_form));</span><br><span class="line">            <span class="keyword">if</span> (!add_content(error_500_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 报文语法错误，404</span></span><br><span class="line">        <span class="keyword">case</span> BAD_REQUEST:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 状态行--400 Bad Request:请求报文存在语法错误</span></span><br><span class="line">            add_status_line(<span class="number">404</span>, error_404_title);</span><br><span class="line">            <span class="comment">// 消息报头</span></span><br><span class="line">            add_headers(<span class="built_in">strlen</span>(error_404_form));</span><br><span class="line">            <span class="keyword">if</span> (!add_content(error_404_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 资源没有访问权限，403</span></span><br><span class="line">        <span class="keyword">case</span> FORBIDDEN_REQUEST:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 状态行--403 Forbidden：请求被服务器拒绝</span></span><br><span class="line">            add_status_line(<span class="number">403</span>, error_403_title);</span><br><span class="line">            <span class="comment">// 消息报头</span></span><br><span class="line">            add_headers(<span class="built_in">strlen</span>(error_403_form));</span><br><span class="line">            <span class="keyword">if</span> (!add_content(error_403_form))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件存在且可以访问，200</span></span><br><span class="line">        <span class="keyword">case</span> FILE_REQUEST:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 状态行--200 OK:客户端请求被正常处理</span></span><br><span class="line">            add_status_line(<span class="number">200</span>, ok_200_title);</span><br><span class="line">            <span class="comment">// GET请求，请求访问的文件有内容</span></span><br><span class="line">            <span class="keyword">if</span> (m_file_stat.st_size != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 消息报头</span></span><br><span class="line">                add_headers(m_file_stat.st_size);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将向量缓冲区分别指向 m_write_buf与m_file_address</span></span><br><span class="line">                <span class="comment">// 之后可以通过writev函数将两个缓冲区的数据写入到用于通信的套接字写缓冲区，返回给客户端</span></span><br><span class="line">                <span class="comment">// 第一个iovec指针指向响应报文缓冲区，长度指向m_write_idx</span></span><br><span class="line">                m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">                m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">                <span class="comment">// 第二个iovec指针指向mmap返回的文件指针，长度指向文件大小</span></span><br><span class="line">                m_iv[<span class="number">1</span>].iov_base = m_file_address;</span><br><span class="line">                m_iv[<span class="number">1</span>].iov_len = m_file_stat.st_size;</span><br><span class="line">                m_iv_count = <span class="number">2</span>;</span><br><span class="line">                <span class="comment">// 发送的全部数据大小，为响应报文m_write_buf中的数据大小，加上文件的大小</span></span><br><span class="line">                bytes_to_send = m_write_idx + m_file_stat.st_size;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 除FILE_REQUEST状态外，其余状态只申请一个iovec，指向响应报文缓冲区</span></span><br><span class="line">    m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">    m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">    m_iv_count = <span class="number">1</span>;</span><br><span class="line">    bytes_to_send = m_write_idx;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h4 id="3-为响应报文添加内容的相关函数"><a href="#3-为响应报文添加内容的相关函数" class="headerlink" title="3.为响应报文添加内容的相关函数"></a>3.为响应报文添加内容的相关函数</h4><blockquote>
<p><code>add_status_line</code>函数，添加状态行：<code>http/1.1 </code>状态码 状态消息</p>
<p><code>add_headers</code>函数添加消息报头，内部调用<code>add_content_length</code>和<code>add_linger</code>函数</p>
<ul>
<li><code>content-length</code>记录响应报文长度，用于浏览器端判断服务器是否发送完数据</li>
<li><code>connection</code>记录连接状态，用于告诉浏览器端保持长连接</li>
</ul>
<p><code>add_blank_line</code>添加空行</p>
</blockquote>
<h5 id="（1）add-response"><a href="#（1）add-response" class="headerlink" title="（1）add_response()"></a>（1）add_response()</h5><p>该函数非常重要，为响应报文的公共函数，为响应报文按照format格式添加一行数据，写入到<code>m_write_buf</code>中，并且更新<code>m_write_idx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  func:添加响应报文的公共函数</span></span><br><span class="line"><span class="comment"> *       --为响应报文按照format格式添加一行数据，写入到m_write_buf中，并且更新m_write_idx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_response</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//如果写入内容超出m_write_buf大小则报错</span></span><br><span class="line">    <span class="keyword">if</span> (m_write_idx &gt;= WRITE_BUFFER_SIZE)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 定义可变参数列表</span></span><br><span class="line">    va_list arg_list;</span><br><span class="line">    <span class="comment">// 将变量arg_list初始化为传入参数(初始化 va_list 变量，使其指向变长参数列表的第一个参数)</span></span><br><span class="line">    va_start(arg_list, format);</span><br><span class="line">    <span class="comment">// 将数据format从可变参数列表写入缓冲区写，返回写入数据的长度</span></span><br><span class="line">    <span class="type">int</span> len=vsnprintf(m_write_buf+m_write_idx,WRITE_BUFFER_SIZE<span class="number">-1</span>-m_write_idx,format,arg_list);</span><br><span class="line">    <span class="comment">//如果写入的数据长度超过缓冲区剩余空间，则报错</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt;= (WRITE_BUFFER_SIZE - <span class="number">1</span> - m_write_idx))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// va_end结束 va_list 的使用</span></span><br><span class="line">        va_end(arg_list);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新m_write_idx位置</span></span><br><span class="line">    m_write_idx += len;</span><br><span class="line">    <span class="comment">// 清空可变参列表</span></span><br><span class="line">    va_end(arg_list);</span><br><span class="line"></span><br><span class="line">    LOG_INFO(<span class="string">&quot;request:%s&quot;</span>, m_write_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="（2）其他函数"><a href="#（2）其他函数" class="headerlink" title="（2）其他函数"></a>（2）其他函数</h5><p>如下的7个函数，均是内部调用<code>add_response</code>函数更新<code>m_write_idx</code>指针和缓冲区<code>m_write_buf</code>中的内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加状态行</span></span><br><span class="line"><span class="comment"> *      --响应报文的第一部分(仅一行)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_status_line</span><span class="params">(<span class="type">int</span> status, <span class="type">const</span> <span class="type">char</span> *title)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;%s %d %s\r\n&quot;</span>, <span class="string">&quot;HTTP/1.1&quot;</span>, status, title);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加消息报头--具体的添加文本长度、连接状态和空行</span></span><br><span class="line"><span class="comment"> *      --消息报头为响应报文第二部分(可以由多行组成)</span></span><br><span class="line"><span class="comment"> *      --空行为响应报文第三部分(仅一行)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_headers</span><span class="params">(<span class="type">int</span> content_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_content_length(content_len) &amp;&amp;</span><br><span class="line">           add_linger() &amp;&amp;</span><br><span class="line">           add_blank_line();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加消息报头(第二部分)</span></span><br><span class="line"><span class="comment"> *      --添加Content-Length,表示响应报文的长度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_content_length</span><span class="params">(<span class="type">int</span> content_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;Content-Length:%d\r\n&quot;</span>, content_len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  func:为响应报文添加消息报头(第二部分)</span></span><br><span class="line"><span class="comment"> *       --添加文本类型，这里是html</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_content_type</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;Content-Type:%s\r\n&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加消息报头(第二部分)</span></span><br><span class="line"><span class="comment"> *      --添加连接状态，通知浏览器端是保持连接还是关闭</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_linger</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;Connection:%s\r\n&quot;</span>, (m_linger == <span class="literal">true</span>) ? <span class="string">&quot;keep-alive&quot;</span> : <span class="string">&quot;close&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加消息报头(第二部分)</span></span><br><span class="line"><span class="comment"> *      --添加空行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_blank_line</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:为响应报文添加响应正文(第四部分)</span></span><br><span class="line"><span class="comment"> *      --添加响应正文文本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::add_content</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> add_response(<span class="string">&quot;%s&quot;</span>, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="（3）write"><a href="#（3）write" class="headerlink" title="（3）write()"></a>（3）write()</h5><p><code>proactor</code>模式下，是服务器主线程检测写事件，并且调用<code>http_conn::write</code>函数将响应报文，写入<code>http</code>对象的通信套接字的写缓冲区，发送给浏览器端</p>
<p>该函数具体逻辑如下：</p>
<p>生成响应报文时初始化<code>byte_to_send</code>，包括<code>m_write_buf</code>中数据大小和文件数据大小。通过<code>writev</code>函数循环发送响应报文数据给浏览器端，根据返回值更新<code>byte_have_send</code>和<code>iovec</code>结构体的指针索引偏移和指向缓冲区剩余数据长度，并判断响应报文整体是否发送成功</p>
<blockquote>
<p>若<code>writev</code>单次发送成功，更新<code>byte_to_send</code>和<code>byte_have_send</code>的大小，若响应报文整体发送成功,则取消<code>mmap</code>映射,并判断是否是长连接.</p>
<ul>
<li>长连接重置http类实例，注册读事件，不关闭连接</li>
<li>短连接直接关闭连接</li>
</ul>
<p>若writev单次发送不成功，因为套接字为非阻塞模式，需要判断是否是写缓冲区满了</p>
<ul>
<li>若不是因为缓冲区满了而失败，取消<code>mmap</code>映射，关闭连接</li>
<li>若<code>errno == EAGAIN</code>表示套接字写缓冲区满了，更新<code>iovec</code>结构体的指针索引偏移和指向缓冲区剩余数据长度，并注册写事件，等待下一次写事件触发（套接字边沿触发工作模式下，当写缓冲区从不可写变为可写，触发<code>epollout</code>），因此在此期间无法立即接收到同一用户的下一请求，但可以保证连接的完整性</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * func:将响应报文写入到通信套接字的写缓冲区，发送给浏览器(客户)端</span></span><br><span class="line"><span class="comment"> * note:proActor模式下，是主线程进行I/O操作数据完成，将m_read_buf/m_write_buf数据准备好</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">http_conn::write</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 表示响应报文为空，一般不会出现这种情况</span></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_send == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重新为套接字注册EPOLLONESHOT事件，并且监听读事件</span></span><br><span class="line">        modfd(m_epollfd, m_sockfd, EPOLLIN, m_TRIGMode);</span><br><span class="line">        init();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将响应报文的状态行、消息头、空行和响应正文发送给浏览器端</span></span><br><span class="line">        <span class="comment">// 从process_write函数中指定的iovec向量缓冲区，写入数据到M_socket文件描述符的写缓冲区</span></span><br><span class="line">        <span class="comment">// 发送数据给浏览器端</span></span><br><span class="line">        temp = writev(m_sockfd, m_iv, m_iv_count);</span><br><span class="line">        <span class="comment">// 发送数据失败</span></span><br><span class="line">        <span class="keyword">if</span>(temp &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞模式下，判断errno == EAGAIN 即写缓冲区满</span></span><br><span class="line">            <span class="keyword">if</span>(errno == EAGAIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// m_sockfd重新注册EPOLLONESHOT事件，监听写事件</span></span><br><span class="line">                modfd(m_epollfd, m_sockfd, EPOLLOUT, m_TRIGMode);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取消do_request函数中开启的内存映射</span></span><br><span class="line">            unmap();</span><br><span class="line">            <span class="comment">// return false,之后关闭连接</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新已经发送的字节数量</span></span><br><span class="line">        bytes_have_send += temp;</span><br><span class="line">        <span class="comment">// 更新还未发送字节</span></span><br><span class="line">        bytes_to_send -= temp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// iovec向量缓冲区第一个头部信息的数据已发送完，发送iovec第二个数据</span></span><br><span class="line">        <span class="keyword">if</span> (bytes_have_send &gt;= m_iv[<span class="number">0</span>].iov_len)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 不再继续发送头部信息</span></span><br><span class="line">            m_iv[<span class="number">0</span>].iov_len = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// iovec向量缓冲区 第二个指向URL访问资源文件的指针索引进行偏移</span></span><br><span class="line">            <span class="comment">// iovec向量缓冲区 第一个指针指向的是m_write_buf，此时m_write_buf数据已经发送完毕</span></span><br><span class="line">            <span class="comment">// 因此用 整体已经发送的字节数量bytes_have_send - m_write_buf中的字节数量可以得到 第二个指向URL访问资源文件的指针索引进行偏移</span></span><br><span class="line">            m_iv[<span class="number">1</span>].iov_base = m_file_address + (bytes_have_send - m_write_idx);</span><br><span class="line">            <span class="comment">// 缓冲区剩余未发送数据的大小</span></span><br><span class="line">            m_iv[<span class="number">1</span>].iov_len = bytes_to_send;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 继续发送iovec向量缓冲区第一个头部信息的数据</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// iovec向量缓冲区 第一个指向m_write_buf的指针索引进行偏移</span></span><br><span class="line">            m_iv[<span class="number">0</span>].iov_base = m_write_buf + bytes_have_send;</span><br><span class="line">            <span class="comment">// 缓冲区剩余未发送数据的大小</span></span><br><span class="line">            m_iv[<span class="number">0</span>].iov_len = m_iv[<span class="number">0</span>].iov_len - bytes_have_send;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断条件，数据已全部发送完</span></span><br><span class="line">        <span class="keyword">if</span> (bytes_to_send &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 取消内存映射</span></span><br><span class="line">            unmap();</span><br><span class="line">            <span class="comment">// 重新注册写事件</span></span><br><span class="line">            modfd(m_epollfd, m_sockfd, EPOLLIN, m_TRIGMode);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 浏览器的请求为长连接</span></span><br><span class="line">            <span class="keyword">if</span> (m_linger)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 重新初始化HTTP对象</span></span><br><span class="line">                init();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// return false,之后关闭连接</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://maxswordsman.github.io">Maxswordsman</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://maxswordsman.github.io/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%8B%EF%BC%886%EF%BC%89/">https://maxswordsman.github.io/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%8B%EF%BC%886%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://maxswordsman.github.io" target="_blank">Maxswordsman</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a></div><div class="post_share"><div class="social-share" data-image="/image/head2.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--%20%E5%AE%9A%E6%97%B6%E5%99%A8%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5-%E4%B8%8A%EF%BC%887%EF%BC%89/" title="TinywebServer代码详解-定时器处理非活动连接-上（7）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TinywebServer代码详解-定时器处理非活动连接-上（7）</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%AD%EF%BC%885%EF%BC%89/" title="TinywebServer代码详解-http连接处理-中（5）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">TinywebServer代码详解-http连接处理-中（5）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/14/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/IPV4%E6%B5%81%E5%AA%92%E4%BD%93/IPV4%E6%B5%81%E5%AA%92%E4%BD%93%E9%A1%B9%E7%9B%AE-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/" title="IPV4流媒体网络多播-前置知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">IPV4流媒体网络多播-前置知识</div></div></a></div><div><a href="/2024/05/15/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/IPV4%E6%B5%81%E5%AA%92%E4%BD%93/IPV4%E6%B5%81%E5%AA%92%E4%BD%93%E9%A1%B9%E7%9B%AE-%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/" title="IPV4流媒体网络多播-代码解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-15</div><div class="title">IPV4流媒体网络多播-代码解析</div></div></a></div><div><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--%20%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0%EF%BC%8811%EF%BC%89/" title="TinywebServer代码详解-数据库连接池（11）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">TinywebServer代码详解-数据库连接池（11）</div></div></a></div><div><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--%20%E5%AE%9A%E6%97%B6%E5%99%A8%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5-%E4%B8%8B%EF%BC%888%EF%BC%89/" title="TinywebServer代码详解-定时器处理非活动连接-下（8）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">TinywebServer代码详解-定时器处理非活动连接-下（8）</div></div></a></div><div><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F-%E4%B8%8B%EF%BC%8810%EF%BC%89/" title="TinywebServer代码详解-日志系统-下（10）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">TinywebServer代码详解-日志系统-下（10）</div></div></a></div><div><a href="/2024/01/24/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/WebServerC++/TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3--%20%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%EF%BC%8812%EF%BC%89/" title="TinywebServer代码详解-注册登录（12）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-24</div><div class="title">TinywebServer代码详解-注册登录（12）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/image/head2.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Maxswordsman</div><div class="author-info__description">不颓好胜之心</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/maxswordsman"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/maxswordsman" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:2723937292@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://gitee.com/zhou-xuezhi" target="_blank" title="Gitee"><i class="iconfont  icon-gitee" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TinywebServer%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3%E2%80%93http%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86-%E4%B8%8B%EF%BC%886%EF%BC%89"><span class="toc-text">TinywebServer代码详解–http连接处理-下（6）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">一、基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-stat%E5%87%BD%E6%95%B0"><span class="toc-text">1.stat函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="toc-text">2.内存映射</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89mmap%E5%87%BD%E6%95%B0"><span class="toc-text">（1）mmap函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89munmap%E5%87%BD%E6%95%B0"><span class="toc-text">（2）munmap函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E5%AE%9E%E4%BE%8B"><span class="toc-text">（3）进程通信实例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-iovec"><span class="toc-text">3.iovec</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89readv%E5%87%BD%E6%95%B0"><span class="toc-text">（1）readv函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89writev%E5%87%BD%E6%95%B0"><span class="toc-text">（2）writev函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E5%AE%9E%E4%BE%8B"><span class="toc-text">（3）实例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-va-start"><span class="toc-text">4.va_start</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-vsnprintf"><span class="toc-text">5.vsnprintf()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">二、流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B"><span class="toc-text">1.程序流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-HTTP-CODE%E5%90%AB%E4%B9%89"><span class="toc-text">2.HTTP_CODE含义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="toc-text">三、代码详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-do-request"><span class="toc-text">1.do_request()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-process-write"><span class="toc-text">2.process_write()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%BA%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E6%B7%BB%E5%8A%A0%E5%86%85%E5%AE%B9%E7%9A%84%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-text">3.为响应报文添加内容的相关函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89add-response"><span class="toc-text">（1）add_response()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="toc-text">（2）其他函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89write"><span class="toc-text">（3）write()</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Maxswordsman</div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script defer src="/js/lunar.js"></script><script defer src="/js/day.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>